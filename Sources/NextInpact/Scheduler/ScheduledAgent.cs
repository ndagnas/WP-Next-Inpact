//*******************************************************************************************************************************
// DEBUT DU FICHIER
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// Nom           : ScheduledAgent.cs
// Auteur        : Nicolas Dagnas
// Description   : Implémentation de l'objet ScheduledAgent
// Créé le       : 23/03/2015
// Modifié le    : 04/07/2018
//*******************************************************************************************************************************

//-------------------------------------------------------------------------------------------------------------------------------
#region Using directives
//-------------------------------------------------------------------------------------------------------------------------------
using System;
using System.Net;
using System.Linq;
using System.Text;
using System.Windows;
using System.Diagnostics;
using System.Globalization;
using System.Windows.Media;
using System.IO.IsolatedStorage;
using System.Collections.Generic;
//~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
using Microsoft.Phone.Info;
using Microsoft.Phone.Shell;
using Microsoft.Phone.Scheduler;
using Microsoft.Phone.Net.NetworkInformation;
//-------------------------------------------------------------------------------------------------------------------------------
#endregion
//-------------------------------------------------------------------------------------------------------------------------------

//*******************************************************************************************************************************
// Début du bloc "NextInpact.Scheduler"
//*******************************************************************************************************************************
namespace NextInpact.Scheduler
	{

	//   ####   ###   #   #  #####  ####   #   #  #      #####  #### 
	//  #      #   #  #   #  #      #   #  #   #  #      #      #   #
	//   ###   #      #####  ###    #   #  #   #  #      ###    #   #
	//      #  #   #  #   #  #      #   #  #   #  #      #      #   #
	//  ####    ###   #   #  #####  ####    ###   #####  #####  #### 

	//***************************************************************************************************************************
	// Classe ScheduledAgent
	//***************************************************************************************************************************
	#region // Déclaration et Implémentation de l'Objet
	//---------------------------------------------------------------------------------------------------------------------------
	/// <summary>
	/// Définit le comportement de l'agent.
	/// </summary>
	//---------------------------------------------------------------------------------------------------------------------------
	public class ScheduledAgent : ScheduledTaskAgent
		{
		//***********************************************************************************************************************
		#region // Classe FlipTileOptions
		//-----------------------------------------------------------------------------------------------------------------------
		class FlipTileOptions
			{
			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Tile"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromTile ( ShellTile Tile )
				{
				//---------------------------------------------------------------------------------------------------------------
				return FlipTileOptions.FromUri ( Tile.NavigationUri );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la configuration de la tuile celon son type.
			/// </summary>
			/// <param name="Uri"></param>
			/// <returns></returns>
			//-------------------------------------------------------------------------------------------------------------------
			public static FlipTileOptions FromUri ( Uri Uri )
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( Uri.OriginalString )
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // All
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=All" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Next INpact"                        ,
							BackTitle               = "Next INpact"                        ,
							Uri                     = string.Empty                         ,
							SmallBackgroundImage    = "Assets/Tiles/All/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/All/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/All/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/All/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/All/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Bookmarks
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Bookmarks" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Mes favoris"                              ,
							BackTitle               = "Mes favoris"                              ,
							Uri                     = string.Empty                               ,
							SmallBackgroundImage    = "Assets/Tiles/Bookmarks/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Bookmarks/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Bookmarks/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Bookmarks/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Bookmarks/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Folders
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Folders" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Dossiers"                               ,
							BackTitle               = "Dossiers"                               ,
							Uri                     = "https://m.nextinpact.com/dossiers"      ,
							SmallBackgroundImage    = "Assets/Tiles/Folders/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Folders/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Folders/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Folders/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Folders/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Forum
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Forum" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Forum"                                ,
							BackTitle               = "Forum"                                ,
							Uri                     = string.Empty                           ,
							SmallBackgroundImage    = "Assets/Tiles/Forum/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Forum/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Forum/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Forum/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Forum/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Shoutbox
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Shoutbox" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Shoutbox"                                ,
							BackTitle               = "Shoutbox"                                ,
							Uri                     = string.Empty                              ,
							SmallBackgroundImage    = "Assets/Tiles/Shoutbox/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Shoutbox/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Shoutbox/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Shoutbox/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Shoutbox/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // GoodDeals
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=GoodDeals" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Bons plans"                               ,
							BackTitle               = "Bons plans"                               ,
							Uri                     = "https://m.nextinpact.com/bons-plans"      ,
							SmallBackgroundImage    = "Assets/Tiles/GoodDeals/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/GoodDeals/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/GoodDeals/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/GoodDeals/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/GoodDeals/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Tests
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Tests" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Tests"                                ,
							BackTitle               = "Tests"                                ,
							Uri                     = "https://m.nextinpact.com/tests"       ,
							SmallBackgroundImage    = "Assets/Tiles/Tests/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Tests/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Tests/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Tests/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Tests/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Culture
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Culture" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Culture"                                ,
							BackTitle               = "Culture"                                ,
							Uri                     = "https://m.nextinpact.com?cat=7"         ,
							SmallBackgroundImage    = "Assets/Tiles/Culture/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Culture/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Culture/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Culture/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Culture/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Drafting
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Drafting" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Notes - Rédac."                          ,
							BackTitle               = "Notes - Rédac."                          ,
							Uri                     = "https://m.nextinpact.com?cat=8"          ,
							SmallBackgroundImage    = "Assets/Tiles/Drafting/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Drafting/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Drafting/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Drafting/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Drafting/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Economy
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Economy" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Économie"                               ,
							BackTitle               = "Économie"                               ,
							Uri                     = "https://m.nextinpact.com?cat=6"         ,
							SmallBackgroundImage    = "Assets/Tiles/Economy/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Economy/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Economy/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Economy/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Economy/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Hardware
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Hardware" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Matériel"                                ,
							BackTitle               = "Matériel"                                ,
							Uri                     = "https://m.nextinpact.com?cat=1"          ,
							SmallBackgroundImage    = "Assets/Tiles/Hardware/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Hardware/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Hardware/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Hardware/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Hardware/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Internet
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Internet" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Internet"                                ,
							BackTitle               = "Internet"                                ,
							Uri                     = "https://m.nextinpact.com?cat=3"          ,
							SmallBackgroundImage    = "Assets/Tiles/Internet/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Internet/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Internet/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Internet/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Internet/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Law
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Law" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Droit"                              ,
							BackTitle               = "Droit"                              ,
							Uri                     = "https://m.nextinpact.com?cat=5"     ,
							SmallBackgroundImage    = "Assets/Tiles/Law/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Law/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Law/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Law/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Law/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Mobility
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Mobility" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Mobilité"                                ,
							BackTitle               = "Mobilité"                                ,
							Uri                     = "https://m.nextinpact.com?cat=4"          ,
							SmallBackgroundImage    = "Assets/Tiles/Mobility/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Mobility/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Mobility/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Mobility/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Mobility/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					#region // Software
					//-----------------------------------------------------------------------------------------------------------
					case "/Frames/Frm_Home.xaml?Section=Software" :
						{
						//-------------------------------------------------------------------------------------------------------
						return new FlipTileOptions ()
							{
							//---------------------------------------------------------------------------------------------------
							Title                   = "Logiciels"                               ,
							BackTitle               = "Logiciels"                               ,
							Uri                     = "https://m.nextinpact.com?cat=2"          ,
							SmallBackgroundImage    = "Assets/Tiles/Software/FlipTileSmall.png" ,
							BackgroundImage         = "Assets/Tiles/Software/FlipTileMedium.png",
							WideBackgroundImage     = "Assets/Tiles/Software/FlipTileWide.png"  ,
							BackBackgroundImage     = "Assets/Tiles/Software/BackTileMedium.png",
							WideBackBackgroundImage = "Assets/Tiles/Software/BackTileWide.png"  ,
							//---------------------------------------------------------------------------------------------------
							};
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				
				//---------------------------------------------------------------------------------------------------------------
				return new FlipTileOptions ()
					{
					//-----------------------------------------------------------------------------------------------------------
					Title                   = "Next INpact"                    ,
					BackTitle               = "Next INpact"                    ,
					Uri                     = string.Empty                     ,
					SmallBackgroundImage    = "Assets/Tiles/FlipTileSmall.png" ,
					BackgroundImage         = "Assets/Tiles/FlipTileMedium.png",
					WideBackgroundImage     = "Assets/Tiles/FlipTileWide.png"  ,
					BackBackgroundImage     = "Assets/Tiles/BackTileMedium.png",
					WideBackBackgroundImage = "Assets/Tiles/BackTileWide.png"  ,
					//-----------------------------------------------------------------------------------------------------------
					};
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//-------------------------------------------------------------------------------------------------------------------
			public string Title                   { get; private set; }
			public string BackTitle               { get; private set; }
			public string Uri                     { get; private set; }
			public string SmallBackgroundImage    { get; private set; }
			public string BackgroundImage         { get; private set; }
			public string WideBackgroundImage     { get; private set; }
			public string BackBackgroundImage     { get; private set; }
			public string WideBackBackgroundImage { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Structure FlipTileInfos
		//-----------------------------------------------------------------------------------------------------------------------
		struct FlipTileInfos
			{
			//-------------------------------------------------------------------------------------------------------------------
			public string   Title       { get; set; }
			public DateTime PublishDate { get; set; }
			public string   Link        { get; set; }
			public string   Uri         { get; set; }
			public string   ArticleID   { get; set; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe DownloadDataState
		//-----------------------------------------------------------------------------------------------------------------------
		class DownloadDataState
			{
			//-------------------------------------------------------------------------------------------------------------------
			// Section des Attributs
			//-------------------------------------------------------------------------------------------------------------------
			private List<string> UriList = new List<string> ();
			//-------------------------------------------------------------------------------------------------------------------

			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public DownloadDataState ()
				{
				//---------------------------------------------------------------------------------------------------------------
				Items = new List<FlipTileInfos> ();

				this.LastAppLaunch  = StorageSettings.GetValue ( "agent-last-app-launch" , DateTime.MinValue );
				this.LastToastCheck = StorageSettings.GetValue ( "agent-last-toast-check", DateTime.MinValue );

				this.CheckToast = ( ScheduledAgent.ToastDelay > 0 && DateTime.Now.Subtract 
				                       ( LastToastCheck ).TotalHours > ScheduledAgent.ToastDelay );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				this.UriList.Add ( "https://m.nextinpact.com" );

				if ( ScheduledAgent.TileIsActive )
					{
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )
						{
						var Infos = FlipTileOptions.FromTile ( Tile );

						if ( ! string.IsNullOrEmpty ( Infos.Uri ) && ! this.UriList.Contains ( Infos.Uri ) )
							this.UriList.Add ( Infos.Uri );
						}
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			
			//-------------------------------------------------------------------------------------------------------------------
			public bool                CheckToast     { get; private set; }
			public DateTime            LastAppLaunch  { get; private set; }
			public DateTime            LastToastCheck { get; private set; }
			public List<FlipTileInfos> Items          { get; private set; }
			//-------------------------------------------------------------------------------------------------------------------

			//*******************************************************************************************************************
			/// <summary>
			/// 
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public Uri Uri
				{
				//---------------------------------------------------------------------------------------------------------------
				get { return ( this.UriList.Count == 0 ) ? null : new Uri ( this.UriList[0] ); }
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Obtiens la prochaine Uri à traiter.
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void Notify ()
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( this.UriList.Count > 0 ) this.UriList.RemoveAt ( 0 );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************

			//*******************************************************************************************************************
			/// <summary>
			/// Prévient que le processus est finit.
			/// </summary>
			//-------------------------------------------------------------------------------------------------------------------
			public void NotifyComplete ()
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( this.CheckToast )
					StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now );
				//---------------------------------------------------------------------------------------------------------------
				}
			//*******************************************************************************************************************
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Classe FlipTileInfosComparer
		//-----------------------------------------------------------------------------------------------------------------------
		class FlipTileInfosComparer : IComparer<FlipTileInfos>
			{
			//-------------------------------------------------------------------------------------------------------------------
			public int Compare ( FlipTileInfos X, FlipTileInfos Y )
				{ return ( X.PublishDate > Y.PublishDate ) ? -1 : 1; }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		// Section des Constantes
		//-----------------------------------------------------------------------------------------------------------------------
		private static string UserAgent = string.Empty;
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		#region // Section du Constructeur
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <remarks>
		/// Le constructeur ScheduledAgent initialise le gestionnaire UnhandledException.
		/// </remarks>
		//-----------------------------------------------------------------------------------------------------------------------
		static ScheduledAgent ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( delegate 
			                   { Application.Current.UnhandledException += UnhandledException; } );
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				string UserAgentMask = string.Empty;

				string OsVersion    = "8.0";
				string DeviceName   = "Lumia XXX";
				string Manufacturer = "Nokia";

				if ( Environment.OSVersion.Version.Major < 8 )
					{
					UserAgentMask = "Mozilla/5.0 (compatible; MSIE 9.0; Windows Phone OS {0};" +
									" Trident/5.0; IEMobile/9.0; Touch; {1}; {2})";

					if ( Environment.OSVersion.Version.Minor < 10 ) OsVersion = "7.0";
					else                                            OsVersion = "7.5";
					}
				else
					{
					UserAgentMask = "Mozilla/5.0 (compatible; MSIE 10.0; Windows Phone OS {0};" +
									" Trident/6.0; IEMobile/10.0; ARM; Touch; {1}; {2})";

					if ( Environment.OSVersion.Version.Minor < 10 ) OsVersion = "8.0";
					else                                            OsVersion = "8.1";
					}

				try
					{
					Manufacturer = DeviceStatus.DeviceManufacturer.ToTitleCase ();
					DeviceName   = DeviceStatus.DeviceName        .ToTitleCase ();
					}
				catch {}

				UserAgent = string.Format ( UserAgentMask, OsVersion, Manufacturer, DeviceName  );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Se produit quand une exception est générée.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args">
		/// <b>ApplicationUnhandledExceptionEventArgs</b> qui contient les données d'événement.
		/// </param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UnhandledException ( object Sender, ApplicationUnhandledExceptionEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			Args.Handled = true;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
	
		//***********************************************************************************************************************
		#region // Section des Procédures Privées
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Découpe la chaine en plusieurs chaines plus petites
		/// </summary>
		/// <param name="Value">Chaine à découper.</param>
		/// <returns>Chaine découpée.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private static string WordWrap ( string Value, int Size, int MaxLines )
			{
			//-------------------------------------------------------------------------------------------------------------------
			int LastWhiteSpace = -1;
			var Buffer         = new StringBuilder ();
			var Result         = new StringBuilder ();
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			for ( int Index = 0 ; Index < Value.Length && MaxLines > 0 ; Index ++ )
				{
				//---------------------------------------------------------------------------------------------------------------
				char Car = Value[Index];

				if ( Char.IsWhiteSpace ( Car ) ) LastWhiteSpace = Index;

				Buffer.Append ( Car );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				if ( Buffer.Length >= Size && LastWhiteSpace > -1 )
					{
					//-----------------------------------------------------------------------------------------------------------
					if ( MaxLines > 0 )
						{
						//-------------------------------------------------------------------------------------------------------
						Result.Append ( Buffer.ToString ( 0, LastWhiteSpace ) );

						if ( MaxLines > 1 )
							{
							Result.Append ( "&#13;" );
							}
						else
							{
							if ( Index == Value.Length ) Result.Append ( "."     );
							else                         Result.Append ( " ..."  );
							}

						Buffer = new System.Text.StringBuilder ();

						Index  = -1;
						MaxLines --;

						Value = Value.Substring ( LastWhiteSpace + 1 );
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			if ( Buffer.Length > 0 && MaxLines > 0 ) Result.Append ( Buffer.ToString () );

			string FinalResult = Result.ToString ();

			if ( ! FinalResult.EndsWith ( "." ) ) FinalResult += ".";

			return FinalResult;
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // Section de Gestion de la Tuile
		//-----------------------------------------------------------------------------------------------------------------------

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static FlipTileData GetTileData ( FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			string XmlContent = String.Empty;
			//-------------------------------------------------------------------------------------------------------------------
				
			//-------------------------------------------------------------------------------------------------------------------
			string TitleClear     = ( string.IsNullOrEmpty ( Config.Title     ) ) ? "Action=\"Clear\"" : "";
			string BackTitleClear = ( string.IsNullOrEmpty ( Config.BackTitle ) ) ? "Action=\"Clear\"" : "";
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile avec article
			//-------------------------------------------------------------------------------------------------------------------
			if ( string.IsNullOrEmpty ( Content ) )
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                   +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                    +
					         "  <wp:Count>0</wp:Count>\n"                                                     +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                               +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n" +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"           +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"   +
					         "  <wp:BackTitle Action=\"Clear\" />\n"                                          +
					         "  <wp:BackContent Action=\"Clear\" />\n"                                        +
					         "  <wp:WideBackContent Action=\"Clear\" />\n"                                    +
					         "  <wp:BackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"            +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\" Action=\"Clear\" />\n"        +
					         " </wp:Tile>\n"                                                                  +
					         "</wp:Notification>";

				XmlContent = string.Format ( XmlContent, TitleClear                 , 
					                                     Config.Title               , 
					                                     Config.SmallBackgroundImage, 
					                                     Config.BackgroundImage     , 
					                                     Config.WideBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			// Tuile sans article
			//-------------------------------------------------------------------------------------------------------------------
			else
				{
				//---------------------------------------------------------------------------------------------------------------
				#region // Déclaration du corp
				//---------------------------------------------------------------------------------------------------------------
				XmlContent = "<?xml version=\"1.0\" encoding=\"utf-8\"?>\n"                                          +
					         "<wp:Notification xmlns:wp=\"WPNotification\" Version=\"2.0\">\n"                       +
					         " <wp:Tile Id=\"1\" Template=\"FlipTile\">\n"                                           +
					         "  <wp:Count>0</wp:Count>\n"                                                            +
					         "  <wp:Title {0}>{1}</wp:Title>\n"                                                      +
					         "  <wp:SmallBackgroundImage IsRelative=\"true\">{2}</wp:SmallBackgroundImage>\n"        +
					         "  <wp:BackgroundImage IsRelative=\"true\">{3}</wp:BackgroundImage>\n"                  +
					         "  <wp:WideBackgroundImage IsRelative=\"true\">{4}</wp:WideBackgroundImage>\n"          +
					         "  <wp:BackTitle {5}>{6}</wp:BackTitle>\n"                                              +
					         "  <wp:BackContent>{7}</wp:BackContent>\n"                                              +
					         "  <wp:WideBackContent>{8}</wp:WideBackContent>\n"                                      +
					         "  <wp:BackBackgroundImage IsRelative=\"true\">{9}</wp:BackBackgroundImage>\n"          +
					         "  <wp:WideBackBackgroundImage IsRelative=\"true\">{10}</wp:WideBackBackgroundImage>\n" +
					         " </wp:Tile>\n" +
					         "</wp:Notification>";
					
				XmlContent = string.Format ( XmlContent, TitleClear                     , 
					                                     Config.Title                   , 
					                                     Config.SmallBackgroundImage    , 
					                                     Config.BackgroundImage         , 
					                                     Config.WideBackgroundImage     ,
					                                     BackTitleClear                 , 
					                                     Config.BackTitle               , 
					                                     Content                        , 
					                                     WordWrap ( Content, 26, 3 )    ,
					                                     Config.BackBackgroundImage     ,
					                                     Config.WideBackBackgroundImage );
				//---------------------------------------------------------------------------------------------------------------
				#endregion
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return new FlipTileData ( XmlContent );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTiles ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				Deployment.Current.Dispatcher.BeginInvoke ( () =>
					{
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )	
						{ ScheduledAgent.ClearTile ( Tile, FlipTileOptions.FromTile ( Tile ) ); }
					//-----------------------------------------------------------------------------------------------------------
					} );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void ClearTile ( ShellTile Tile, FlipTileOptions Images )
			{
			//-------------------------------------------------------------------------------------------------------------------
			ScheduledAgent.UpdateTile ( Tile, Images, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère l'affichage final de la tuile.
		/// </summary>
		/// <param name="Tile">Tuile à mettre à jour.</param>
		/// <param name="Images">Configuration de la tuile.</param>
		/// <param name="Content">Texte à afficher.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private static void UpdateTile ( ShellTile Tile, FlipTileOptions Config, string Content )
			{
			//-------------------------------------------------------------------------------------------------------------------
			try { Tile.Update ( GetTileData ( Config, Content ) ); } catch {}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // Section des Procédures de Traitement
		//-----------------------------------------------------------------------------------------------------------------------
		
		//***********************************************************************************************************************
		/// <summary>
		/// Met à jour les tuiles et lance les notifications.
		/// </summary>
		/// <param name="State">Object ontenant les informations à traiter.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnFinalProcess ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			Deployment.Current.Dispatcher.BeginInvoke ( () =>
				{
				//---------------------------------------------------------------------------------------------------------------
				State.Items.Sort ( new FlipTileInfosComparer () );
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				// On a du contenue, on récupère la liste des Tuiles
				//---------------------------------------------------------------------------------------------------------------
				var Tiles = new Dictionary<ShellTile, FlipTileOptions> ();

				if ( ScheduledAgent.TileIsActive )
					foreach ( ShellTile Tile in ShellTile.ActiveTiles )
						{ Tiles[Tile] = FlipTileOptions.FromTile ( Tile ); }
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				int           ToastCount   = 0;
				FlipTileInfos ToastContent = new FlipTileInfos ();
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				try
					{
					//-----------------------------------------------------------------------------------------------------------
					// Lecture des Eléments
					//-----------------------------------------------------------------------------------------------------------
					foreach ( FlipTileInfos Item in State.Items )
						{
						//-------------------------------------------------------------------------------------------------------
						var ProcessedTiles = new List <ShellTile> ();

						foreach ( ShellTile Tile in Tiles.Keys )
							{
							FlipTileOptions TileInfos = Tiles[Tile];

							if ( string.IsNullOrEmpty ( TileInfos.Uri ) || 
							                          TileInfos.Uri.EqualsIgnoreCase ( Item.Uri ) )
								{
								ScheduledAgent.UpdateTile ( Tile, Tiles[Tile], Item.Title );

								ProcessedTiles.Add ( Tile );
								}
							}

						foreach ( ShellTile Tile in ProcessedTiles ) { Tiles.Remove ( Tile ); }
						//-------------------------------------------------------------------------------------------------------

						//-------------------------------------------------------------------------------------------------------
						// Est ce qu'on check les Toast ?
						//-------------------------------------------------------------------------------------------------------
						if ( State.CheckToast && Item.PublishDate > State.LastToastCheck )
							{
							//---------------------------------------------------------------------------------------------------
							ToastCount ++;
							ToastContent = Item;
							//---------------------------------------------------------------------------------------------------
							}
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				catch {}
				//---------------------------------------------------------------------------------------------------------------
				finally
					{
					//-----------------------------------------------------------------------------------------------------------
					#region // Un nouvel article
					//-----------------------------------------------------------------------------------------------------------
					if ( ToastCount == 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "Nouvel article"                                      ,
							Content       = ToastContent.Title                                    ,
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml?Article="            + 
							                                 ToastContent.Link, UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					#region // Plusieurs nouveaux articles
					//-----------------------------------------------------------------------------------------------------------
					else if ( ToastCount > 1 )
						{
						//-------------------------------------------------------------------------------------------------------
						(new ShellToast ()
							{
							Title         = "Next INpact"                                        ,
							Content       = string.Format ( "tu as {0} nouveaux articles"        +
							                              " à lire sur Next INpact", ToastCount ),
							NavigationUri = new Uri ( "/Frames/Frm_Home.xaml", UriKind.Relative ),
							}).Show ();
						//-------------------------------------------------------------------------------------------------------
						}
					//-----------------------------------------------------------------------------------------------------------
					#endregion
					//-----------------------------------------------------------------------------------------------------------
					
					//-----------------------------------------------------------------------------------------------------------
					// On ré-initialise les tuiles non mise à jour
					//-----------------------------------------------------------------------------------------------------------
					foreach ( ShellTile Tile in Tiles.Keys )
						{ ScheduledAgent.ClearTile ( Tile, Tiles[Tile] ); }

					State.NotifyComplete ();
					base .NotifyComplete ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				} );
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Gère la réponse à la récupération des derniers articles.
		/// </summary>
		/// <param name="Sender">Objet source de l'appel.</param>
		/// <param name="Args"><b>...EventArgs</b> qui contient les données d'événement.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		private void OnGetLastArticlesSuccess ( object S, DownloadStringCompletedEventArgs Args )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			DownloadDataState State = (DownloadDataState)Args.UserState;

			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				// S'il y a eu une erreur ou une exception, on arrête
				//---------------------------------------------------------------------------------------------------------------
				if ( Args.Cancelled                       ) return;
				if ( Args.Error                   != null ) return;
				if ( string.IsNullOrEmpty ( Args.Result ) ) return;
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				int Index = -1;

				while ( ( Index = Args.Result.IndexOf ( "<article ", Index + 1 ) ) != -1 )
					{
					//-----------------------------------------------------------------------------------------------------------
					int EndBlock = Args.Result.IndexOf ( "</article>", Index );

					if ( EndBlock == -1 ) continue;
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					string Article = Args.Result.Substring ( Index, EndBlock - Index + 10 );
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					// Récupération de la Date
					//-----------------------------------------------------------------------------------------------------------
					int DatePosition = Article.IndexOf ( "data-datepubli" );

					if ( DatePosition == -1 ) continue;

					string publishDate = Article.Substring ( DatePosition + 16, 19 );

					DateTime PublishDate = DateTime.MinValue;

					bool DateResult = DateTime.TryParseExact ( publishDate, "dd/MM/yyyy HH:mm:ss", 
					                                  null, DateTimeStyles.None, out PublishDate );
					if ( ! DateResult ) continue;

					if ( PublishDate < State.LastAppLaunch ) break;
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					// Recupération du lien
					//-----------------------------------------------------------------------------------------------------------
					int LinkPosition = Article.IndexOf ( "href=", DatePosition );

					if ( LinkPosition == -1 ) continue;

					int EndLinkPosition = Article.IndexOf ( "\"", LinkPosition + 6 );

					if ( EndLinkPosition == -1 ) continue;

					string Link = Article.Substring ( LinkPosition + 6, EndLinkPosition - 
					                                                            LinkPosition - 6 );
					if ( ! Link.StartsWith ( "/" ) ) Link = "/" + Link;

					Link = "https://" + State.Uri.Host + Link;
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					// Recupération du titre
					//-----------------------------------------------------------------------------------------------------------
					int TitlePosition = Article.IndexOf ( "alt=", LinkPosition );

					if ( TitlePosition == -1 ) continue;

					int EndTitlePosition = Article.IndexOf ( "\"", TitlePosition + 5 );

					if ( EndTitlePosition == -1 ) continue;

					string Title = HttpUtility.HtmlDecode ( Article.Substring ( TitlePosition + 5, 
					                                      EndTitlePosition - TitlePosition - 5 ) );
					//-----------------------------------------------------------------------------------------------------------

					//-----------------------------------------------------------------------------------------------------------
					State.Items.Add ( new FlipTileInfos ()
						{
						Title       = Title                   ,
						PublishDate = PublishDate             ,
						Link        = Link                    ,
						Uri         = State.Uri.OriginalString,
						} );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				CancelNotify = true;
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally
				{
				//---------------------------------------------------------------------------------------------------------------
				State.Notify ();

				if ( ! CancelNotify ) base.NotifyComplete       (       );
				else                  this.AsyncGetLastArticles ( State );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Récupère les derniers articles publiés.
		/// </summary>
		/// <returns><b>True</b> si le traitement est en cours, sinon <b>False</b>.</returns>
		//-----------------------------------------------------------------------------------------------------------------------
		private bool AsyncGetLastArticles ( DownloadDataState State )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				Uri Uri = State.Uri;

				if ( Uri != null )
					{
					//-----------------------------------------------------------------------------------------------------------
					var WebClient = new WebClient ();

					WebClient.Headers["User-Agent"] = UserAgent;

					WebClient.DownloadStringCompleted += this.OnGetLastArticlesSuccess;

					WebClient.DownloadStringAsync ( Uri, State );
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------

				//---------------------------------------------------------------------------------------------------------------
				else { this.OnFinalProcess ( State ); }
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch { return false; }
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			return true;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		/// <summary>
		/// Agent qui exécute une tâche planifiée.
		/// </summary>
		/// <param name="task">La tâche appelée.</param>
		//-----------------------------------------------------------------------------------------------------------------------
		protected override void OnInvoke ( ScheduledTask task )
			{
			//-------------------------------------------------------------------------------------------------------------------
			#region // Implémentation de la Procédure
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			bool CancelNotify = false;
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			try
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! TileIsActive && ToastDelay == 0           ) return;
				if ( ! NetworkInterface.GetIsNetworkAvailable () ) return;

				CancelNotify = this.AsyncGetLastArticles ( new DownloadDataState () );
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			catch {}
			//-------------------------------------------------------------------------------------------------------------------
			finally
				{
				//---------------------------------------------------------------------------------------------------------------
				if ( ! CancelNotify )
					{
					//-----------------------------------------------------------------------------------------------------------
					base.NotifyComplete       ();
					ScheduledAgent.ClearTiles ();
					//-----------------------------------------------------------------------------------------------------------
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------

			//-------------------------------------------------------------------------------------------------------------------
			#endregion
			//-------------------------------------------------------------------------------------------------------------------
			}
		//***********************************************************************************************************************
		
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROCEDURE >> Clear
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Purge la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static void Clear ()
			{
			//-------------------------------------------------------------------------------------------------------------------
			StorageSettings.SetValue ( "agent-last-app-launch" , DateTime.Now                    );
			StorageSettings.SetValue ( "agent-last-toast-check", DateTime.Now.AddMinutes ( -30 ) );

			ScheduledAgent.ClearTiles ();
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		
		//***********************************************************************************************************************
		#region // PROCEDURE >> GetTileData
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Obtiens les infos nécessaires à la création de la tuile.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static FlipTileData GetTileData ( Uri Uri )
			{
			//-------------------------------------------------------------------------------------------------------------------
			var TileConfig = FlipTileOptions.FromUri ( Uri );
				
			return ScheduledAgent.GetTileData ( TileConfig, string.Empty );
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> TileIsActive
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si la tuile dynamique est active.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static bool TileIsActive
			{
			//-------------------------------------------------------------------------------------------------------------------
			get { return (bool)StorageSettings.GetValue ( "agent-tile-is-active", false ); }
			set {              StorageSettings.SetValue ( "agent-tile-is-active", value ); }
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************

		//***********************************************************************************************************************
		#region // PROPERTY >> ToastDelay
		//-----------------------------------------------------------------------------------------------------------------------
		/// <summary>
		/// Indique si les notifications sont actives.
		/// </summary>
		//-----------------------------------------------------------------------------------------------------------------------
		public static int ToastDelay
			{
			//-------------------------------------------------------------------------------------------------------------------
			get
				{
				object Value = StorageSettings.GetValue ( "agent-toast-delay" );

				if ( Value == null )
					{
					bool Active = StorageSettings.GetValue ( "agent-toast-is-active", false );

					Value = ( Active ) ? (int)1 : (int)0;

					StorageSettings.SetValue ( "agent-toast-delay", (int)Value );
					}
				
				return (int)Value;
				}
			//-------------------------------------------------------------------------------------------------------------------
			set
				{
				//---------------------------------------------------------------------------------------------------------------
				switch ( value )
					{
					case 1  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 2  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					case 4  : StorageSettings.SetValue ( "agent-toast-delay", value ); break;
					default : StorageSettings.SetValue ( "agent-toast-delay", 0     ); break;
					}
				//---------------------------------------------------------------------------------------------------------------
				}
			//-------------------------------------------------------------------------------------------------------------------
			}
		//-----------------------------------------------------------------------------------------------------------------------
		#endregion
		//***********************************************************************************************************************
		}
	//---------------------------------------------------------------------------------------------------------------------------
	#endregion
	//***************************************************************************************************************************

	} // Fin du namespace "NextInpact.Scheduler"
//*******************************************************************************************************************************

//*******************************************************************************************************************************
// FIN DU FICHIER
//*******************************************************************************************************************************
